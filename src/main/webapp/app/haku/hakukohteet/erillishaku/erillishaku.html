<h1>{{ t('erillishaku.header') || 'Erillishaku' }}</h1>
<div ng-include="'../common/js/topnavigation/topNavigation.html'"/>

<div class="tabsheets">

<div ng-include="'haku/hakukohdelista.html'"></div>

<div class="toggle-content-container overflow-x-scroll">

<div ng-include="'../common/html/hakukohdeNimi.html'"></div>
<div ng-include="'haku/hakukohteet/hakukohdeNavigation.html'"/>
<div class="tabsheets">

<div ng-include="'../common/html/errors.html'"></div>

<a ng-show="model.valinnanvaiheet" ng-click="erillishaunVientiXlsx(); $event.stopPropagation();"
   class="btn btn-default btn-sm excel">{{ t('erillishaku.vietaulukkolaskentaan') || 'Vie
    taulukkolaskentaan' }}</a>
<span class="btn btn-primary btn-sm margin-bottom-2 btn-file">
	    {{ t('erillishaku.tuotaulukkolaskennasta') || 'Tuo taulukkolaskennasta' }} <input type="file" ng-file-select="erillishaunTuontiXlsx($files)" >
</span>
<br/>
<input type="text" class="search margin-vertical-2"
       placeholder="{{ t('valintalaskentatulos.suodatahakijoita') || 'Suodata hakijoita' }}"
       ng-model="hakijaFilter"/>

<pagination-pagesize page-size="pageSize"></pagination-pagesize>
<div ng-if="model.ilmanlaskentaa.length > 0">
    <h2>{{ t('valintalaskentatulos.valinnanvaiheet') || 'Valinnanvaiheet, jossa ei käytetä laskentaa'
        }}</h2>
    <accordion close-others="true">
        <accordion-group
                ng-repeat="valinnanvaihe in model.ilmanlaskentaa | orderBy:['nimi']:false track by $index"
                is-open="$first" ng-init="isLastValinnanvaihe = $last">

            <accordion-heading>
                <h3>{{ t('valintalaskentatulos.valinnanvaihe') || 'Valinnanvaihe' }}: <span
                        ng-bind="valinnanvaihe.nimi">-</span></h3>

            </accordion-heading>

            <div>
                <div ng-repeat="valintatapajono in valinnanvaihe.valintatapajonot track by $index">
                    <form name="form">
                        <h3>{{ t('valintalaskentatulos.valintatapajono') || 'Valintatapajono' }}:
                            {{valintatapajono.nimi}}</h3>
                        <button ng-disabled="!form.$valid"
                                class="btn btn-primary btn-sm margin-bottom-2"
                                ng-click="submit(vaihe.oid, valintatapajono.oid)">{{
                            t('valintalaskentatulos.tallenna') || 'Tallenna' }}
                        </button>
                        <button ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                ng-click="valintatapajonoVientiXlsx(valintatapajono.oid)"
                                class="btn btn-default btn-sm margin-bottom-2">{{
                            t('valintalaskentatulos.vietaulukkolaskentaan') || 'Vie taulukkolaskentaan' }}
                        </button>
				                    <span ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                          class="btn btn-primary btn-sm margin-bottom-2 btn-file">
									    {{ t('valintalaskentatulos.tuotaulukkolaskennasta') || 'Tuo taulukkolaskennasta' }} <input
                                            type="file"
                                            ng-file-select="valintatapajonoTuontiXlsx(valintatapajono.oid, $files)">
									</span>
				                    <span ng-hide="true"
                                          ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                          class="btn btn-primary btn-sm margin-bottom-2 btn-file">
									    {{ t('valintalaskentatulos.tuotaulukkolaskennasta') || 'Tuo taulukkolaskennasta' }} <input
                                            type="file" ng-file-select="valintatapajonoTuontiXlsx($files)">
									</span>
                        <button ng-disabled="!crudOrg"
                                ng-if="!valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                                ng-click="muutaSijoittelunStatus(valintatapajono, 'true')"
                                class="btn btn-primary btn-sm">{{ t('valintalaskentatulos.hyvaksy') ||
                            'Siirrä jono sijoitteluun' }}
                        </button>
                        <button ng-disabled="!crudOrg"
                                ng-if="valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                                ng-click="muutaSijoittelunStatus(valintatapajono, 'false')"
                                class="btn btn-default btn-sm ">{{ t('valintalaskentatulos.hylkaa') ||
                            'Poista jono sijoittelusta' }}
                        </button>
                        <table class="virkailija-table-1">
                            <thead>
                            <tr>
                                <th><a href="" ng-click="reverse=!reverse">{{
                                    t('valintalaskentatulos.jonosija') || 'Jonosija' }}
                                    ({{valintatapajono.jonosijat.length}})</a></th>
                                <th>{{ t('valintalaskentatulos.hakija') || 'Hakija' }}</th>
                                <th>{{ t('valintalaskentatulos.valintatieto') || 'Valintatieto' }}</th>
                                <th>{{ t('valintalaskentatulos.kuvausfi') || 'Kuvaus (FI)' }}</th>
                                <th>{{ t('valintalaskentatulos.kuvaussv') || 'Kuvaus (SV)' }}</th>
                                <th>{{ t('valintalaskentatulos.kuvausen') || 'Kuvaus (EN)' }}</th>
                            </tr>
                            </thead>
                            <tbody>

                            <tr colspan="3" ng-if="!isLastValinnanvaihe"
                                ng-repeat="tulos in filteredResults[$parent.$parent.$index][$parent.$index] = (valintatapajono.jonosijat | filter:hakijaFilter | orderBy:['jonosija', 'sukunimi']:reverse) | startFrom:(currentPage[$parent.$parent.$index][$parent.$index]-1)*pageSize | limitTo:pageSize">
                                <td><input type="number"
                                           ng-model="tulos.jonosija"
                                           min="1"
                                           max="{{valintatapajono.jonosijat.length}}"
                                           ng-change="changeTila(tulos, tulos.jonosija)" ng-debounce="1000"
                                           ng-disabled="tulos.tuloksenTila == 'HYLATTY'"></td>
                                <td class="leftorientedcolumn">
                                    <show-person-information sukunimi="{{tulos.sukunimi}}"
                                                             etunimi="{{tulos.etunimi}}"
                                                             hakemus-oid="{{tulos.hakemusOid}}"
                                                             haku-oid="{{hakuOid}}"
                                                             henkilo-oid="{{tulos.hakijaOid}}"/>
                                </td>
                                <td>
                                    <select ng-model="tulos.tuloksenTila"
                                            ng-change="changeSija(tulos, tulos.tuloksenTila)">
                                        <option value="HYVAKSYTTAVISSA">{{
                                            t('valintalaskentatulos.hyvaksyttavissa') || 'Hyväksyttävissä'
                                            }}
                                        </option>
                                        <option value="HYLATTY">{{ t('valintalaskentatulos.hylatty') ||
                                            'Hylätty' }}
                                        </option>
                                        <option value="">{{ t('valintalaskentatulos.maarittalematon') ||
                                            'Määrittelemätön' }}
                                        </option>
                                        <option value="HYVAKSYTTY_HARKINNANVARAISESTI">{{
                                            t('valintalaskentatulos.harkinnanvaraisesti') || 'Hyväksytty
                                            harkinnanvaraisesti' }}
                                        </option>
                                    </select>
                                </td>
                                <td><input ng-model="tulos.jarjestyskriteerit[0].kuvaus.FI"
                                           size="20"/></td>
                                <td><input ng-model="tulos.jarjestyskriteerit[0].kuvaus.SV"
                                           size="20"/></td>
                                <td><input ng-model="tulos.jarjestyskriteerit[0].kuvaus.EN"
                                           size="20"/></td>
                            </tr>
                            </tbody>

                        </table>
                        <pagination previous-text="{{ t('valintalaskentatulos.edellinen') || 'Edellinen' }}"
                                    next-text="{{ t('valintalaskentatulos.seuraava') || 'Seuraava' }}"
                                    total-items="filteredResults[$parent.$parent.$index][$parent.$index].length"
                                    ng-model="currentPage[$parent.$parent.$index][$parent.$index]"
                                    items-per-page="pageSize"></pagination>
                    </form>
                </div>
            </div>
        </accordion-group>
    </accordion>
</div>

<div ng-if="model.valinnanvaiheet.length > 0">
    <h2>{{ t('valintalaskentatulos.lasketutvalinnanvaiheet') || 'Lasketut valinnanvaiheet' }}</h2>
    <accordion close-others="true">
        <accordion-group
                ng-repeat="valinnanvaihe in model.valinnanvaiheet | orderBy:['createdAt','jarjestysnumero']:true track by $index"
                is-open="$first" ng-init="isLastValinnanvaihe = $last">

            <accordion-heading>
                <h3>{{ t('valintalaskentatulos.valinnanvaihe') || 'Valinnanvaihe' }}: <span
                        ng-bind="valinnanvaihe.nimi">-</span> (<span
                        ng-bind="valinnanvaihe.createdAt | date:'dd.MM.yyyy HH:mm:ss'">-</span>)</h3>

            </accordion-heading>
            <div>
                <div ng-repeat="valintatapajono in valinnanvaihe.valintatapajonot track by $index"
                     ng-if="!valintatapajono.ilmanLaskentaa">
                    <h3>{{ t('valintalaskentatulos.valintatapajono') || 'Valintatapajono' }}:
                        {{valintatapajono.nimi}}</h3>
                    <button ng-disabled="!crudOrg"
                            ng-if="!valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                            ng-click="muutaSijoittelunStatus(valintatapajono, 'true')" class="btn btn-primary btn-sm">{{
                        t('valintalaskentatulos.hyvaksy') || 'Siirrä jono sijoitteluun' }}
                    </button>
                    <button ng-disabled="!crudOrg"
                            ng-if="valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                            ng-click="muutaSijoittelunStatus(valintatapajono, 'false')" class="btn btn-default btn-sm ">
                        {{ t('valintalaskentatulos.hylkaa') || 'Poista jono sijoittelusta' }}
                    </button>
                    <table class="table table-bordered">

                        <tbody ng-init="hakijaSijoittelutulos = getHakijanSijoitteluTulos(tulos)"
                               ng-repeat="tulos in filteredResults[$parent.$parent.$index][$parent.$index] = (valintatapajono.jonosijat  | filter:hakijaFilter) | startFrom:(currentPage[$parent.$parent.$index][$parent.$index]-1)*pageSize | limitTo:pageSize">
                        <tr class="active">
                            <td>{{tulos.jonosija}}</td>
                            <td>
                                <show-person-information sukunimi="{{tulos.sukunimi}}"
                                                         etunimi="{{tulos.etunimi}}"
                                                         hakemus-oid="{{tulos.hakemusOid}}"
                                                         haku-oid="{{hakuOid}}"
                                                         henkilo-oid="{{tulos.hakijaOid}}"/>
                            </td>
                            <td>
                                {{tulos.jarjestyskriteerit[0].arvo}}
                            </td>
                            <td>
                                Ilmoittautumistila: {{hakijaSijoittelutulos.ilmoittautumisTila}}
                            </td>
                            <td>
                                Vastaanottotila: {{hakijaSijoittelutulos.vastaanottoTila}}
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>{{t('erillishaku.laskennantulos') || 'Laskennan tulos'}}</td>
                            <td>{{tulos.tuloksenTila}}</td>
                            <td>

                            </td>
                            <td>
                                <jarjestyskriteeri-muokkaus
                                        jonosija="tulos"
                                        valintatapajono-oid="valintatapajono.valintatapajonooid"
                                        hakemus-oid="tulos.hakemusOid"
                                        enabled="jkmuokkaus"/>
                            </td>
                        </tr>
                        <tr ng-if="isLastValinnanvaihe">
                            <td></td>
                            <td>{{t('erillishaku.sijoitteluntulos') || 'Sijoittelun tulos'}}</td>
                            <td><span ng-if="jono.oid === valintatapajono.oid" ng-repeat="jono in hakijaSijoittelutulos.jonot">{{jono.tila}}</span></td>
                            <td></td>
                            <td>
                                <jarjestyskriteeri-muokkaus
                                        jonosija="tulos"
                                        valintatapajono-oid="valintatapajono.valintatapajonooid"
                                        hakemus-oid="tulos.hakemusOid"
                                        enabled="jkmuokkaus"/>
                            </td>
                        </tr>
                        </tbody>


                    </table>

                    <pagination previous-text="{{ t('valintalaskentatulos.edellinen') || 'Edellinen' }}"
                                next-text="{{ t('valintalaskentatulos.seuraava') || 'Seuraava' }}"
                                total-items="filteredResults[$parent.$parent.$index][$parent.$index].length"
                                ng-model="currentPage[$parent.$parent.$index][$parent.$index]"
                                items-per-page="pageSize"></pagination>
                </div>

            </div>




        </accordion-group>
    </accordion>
</div>


</div>


</div>
<div class="clear"></div>
<div ng-show="showLoading"
     style="position: fixed; top:0; left: 0; background: gold; padding: 0.3em; font-weight: bold;">{{
    t('valintalaskentatulos.kasitellaan') || 'käsitellään' }}...
</div>
</div>
