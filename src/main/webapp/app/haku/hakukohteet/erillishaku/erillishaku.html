<h1>{{ t('erillishaku.header') || 'Erillishaku' }}</h1>
<div ng-include="'../common/js/topnavigation/topNavigation.html'"/>

<div class="tabsheets">

    <div ng-include="'haku/hakukohdelista.html'"></div>

    <div class="toggle-content-container overflow-x-scroll">

        <div ng-include="'../common/html/hakukohdeNimi.html'"></div>
        <div ng-include="'haku/hakukohteet/hakukohdeNavigation.html'"/>
        <div class="tabsheets">

            <div ng-include="'../common/html/errors.html'"></div>

            <input type="text" class="search margin-vertical-2"
                   placeholder="{{ t('valintalaskentatulos.suodatahakijoita') || 'Suodata hakijoita' }}"
                   ng-model="hakijaFilter"/>

            <pagination-pagesize page-size="pageSize"></pagination-pagesize>
            <div>
                <h2>{{ t('valintalaskentatulos.valinnanvaiheet') || 'Valinnanvaiheet'
                    }}</h2>
                <accordion close-others="true">
                    <accordion-group
                            ng-repeat="valinnanvaihe in erillishaku | orderBy:['nimi']:false track by $index"
                            is-open="$first">

                        <accordion-heading>
                            <h3>{{ t('valintalaskentatulos.valinnanvaihe') || 'Valinnanvaihe' }}: <span
                                    ng-bind="valinnanvaihe.nimi">-</span></h3>

                        </accordion-heading>

                        <div>
                            <div ng-repeat="valintatapajono in valinnanvaihe.valintatapajonot track by $index">
                                <form name="form">
                                    <h3>{{ t('valintalaskentatulos.valintatapajono') || 'Valintatapajono' }}:
                                        {{valintatapajono.nimi}}<input type="hidden" value="{{valintatapajono.oid}}"></h3>
                                    <button ng-hide="valintatapajono.kaytetaanValintalaskentaa"
                                            ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                            ng-click="erillishaunVientiXlsx(valintatapajono.oid, valintatapajono.nimi)"
                                            class="btn btn-default btn-sm margin-bottom-2">{{
                                        t('erillishaku.vietaulukkolaskentaan') || 'Vie taulukkolaskentaan' }}
                                    </button>
                                    <span   ng-hide="valintatapajono.kaytetaanValintalaskentaa"
                                            ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                            class="btn btn-primary btn-sm margin-bottom-2 btn-file">
                                        {{ t('erillishaku.tuotaulukkolaskennasta') || 'Tuo taulukkolaskennasta' }} <input
                                            type="file"
                                            ng-file-select="erillishaunTuontiXlsx($files,valintatapajono.oid, valintatapajono.nimi)">
                                    </span>
                                    <a ng-click="luoHyvaksymiskirjeetPDF(); $event.stopPropagation()" class="btn btn-default btn-sm margin-bottom-2 pdf">{{ t('sijoitteluntulos.muodostahyvaksymiskirjeet') || 'Muodosta hyväksymiskirjeet' }}</a>

                                    <button ng-show="valintatapajono.kaytetaanValintalaskentaa"
                                            ng-disabled="!crudOrg && !updateOph"
                                            ng-if="!valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                                            ng-click="muutaSijoittelunStatus(valintatapajono, 'true')" class="btn btn-primary btn-sm">{{
                                        t('valintalaskentatulos.hyvaksy') || 'Siirrä jono sijoitteluun' }}
                                    </button>
                                    <button ng-show="valintatapajono.kaytetaanValintalaskentaa"
                                            ng-disabled="!updateOph"
                                            ng-if="valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                                            ng-click="muutaSijoittelunStatus(valintatapajono, 'false')" class="btn btn-default btn-sm ">
                                        {{ t('valintalaskentatulos.hylkaa') || 'Poista jono sijoittelusta' }}
                                    </button>
                                    <table ng-hide="valintatapajono.kaytetaanValintalaskentaa" class="virkailija-table-1">
                                        <thead>
                                        <tr>
                                            <th ng-show="updateOrg">{{ t('valintalaskentatulos.rivinpoisto') || 'Rivin poisto' }}</th>
                                            <th>{{ t('valintalaskentatulos.hakija') || 'Hakija' }}</th>
                                            <th>{{ t('sijoitteluntulos.hakemuksentila') || 'Hakemuksentila'}}</th>
                                            <th>{{ t('sijoitteluntulos.vastaanottotieto') || 'Vastaanottotieto'}}</th>
                                            <th>{{ t('sijoitteluntulos.ilmoittautumistieto') || 'Ilmoittautumistieto'}}</th>
                                            <th>{{ t('sijoitteluntulos.lisatiedot') || 'Lisätiedot'}}</th>
                                        </tr>
                                        </thead>
                                        <tbody>

                                        <tr ng-repeat="tulos in valintatapajono.hakemukset | orderBy:['jonosija', 'sukunimi']:reverse | startFrom:(valintatapajono.currentPage-1)*pageSize | limitTo:pageSize">
                                            <td ng-show="updateOrg">
                                                <input type="checkbox"
                                                       ng-model="tulos.poistetaankoRivi"
                                                       ng-change="addMuokattuHakemus(tulos)"> <br/>
                                            </td>
                                            <td class="leftorientedcolumn">
                                                <show-person-information sukunimi="{{tulos.sukunimi}}"
                                                                         etunimi="{{tulos.etunimi}}"
                                                                         hakemus-oid="{{tulos.hakemusOid}}"
                                                                         haku-oid="{{hakuOid}}"
                                                                         henkilo-oid="{{tulos.hakijaOid}}"/>
                                            </td>
                                            <td>
                                                <div ng-switch="updateOrg">
                                                    <select ng-switch-when="true"
                                                            ng-model="tulos.hakemuksentila"
                                                            ng-options="opt.value as opt.text for opt in hakemuksentilat"
                                                            ng-change="addMuokattuHakemus(tulos)">
                                                    </select>
                                                    <select disabled="disabled"
                                                            ng-switch-default
                                                            ng-model="tulos.hakemuksentila"
                                                            ng-options="opt.value as opt.text for opt in hakemuksentilat"
                                                            ng-change="addMuokattuHakemus(tulos)">
                                                    </select>
                                                </div>
                                            </td>
                                            <td>
                                                <div>{{ t('sijoitteluntulos.julkaistavissa') || 'Julkaistavissa' }}: <input type="checkbox" ng-change="addMuokattuHakemus(tulos)" ng-model="tulos.julkaistavissa"> <br/></div>
                                                <div ng-show="tulos.julkaistavissa">
                                                    <span ng-bind="t('sijoitteluntulos.hakijallenaytetaan') || 'Hakijalle näytetään'"></span>:
                                                    <span ng-bind="valintatuloksenTilaKielistys(tulos.valintatuloksenTilaHakijalle)"></span>
                                                </div>
                                                <div ng-switch="updateOrg && tulos.julkaistavissa && tulos.valintatuloksentila !== 'OTTANUT_VASTAAN_TOISEN_PAIKAN'">
                                                    <select ng-switch-when="true"
                                                            ng-model="tulos.valintatuloksentila"
                                                            ng-options="opt.value as opt.text disable when opt.disable for opt in valintatuloksentilat"
                                                            ng-change="addMuokattuHakemus(tulos)"/>
                                                    </select>
                                                    <select disabled="disabled"
                                                            ng-switch-default
                                                            ng-model="tulos.valintatuloksentila"
                                                            ng-options="opt.value as opt.text for opt in valintatuloksentilat"
                                                            ng-change="addMuokattuHakemus(tulos)"/>
                                                    </select>
                                                </div>
                                            </td>
                                            <td>
                                                <div ng-switch="updateOrg && isVastaanottanut(tulos.valintatuloksentila) && tulos.julkaistavissa">
                                                    <select ng-switch-when="true"
                                                            ng-model="tulos.ilmoittautumistila"
                                                            ng-options="opt.value as opt.text for opt in ilmoittautumistilat"
                                                            ng-change="addMuokattuHakemus(tulos)"/>
                                                    </select>
                                                    <select disabled="disabled"
                                                            ng-switch-default
                                                            ng-model="tulos.ilmoittautumistila"
                                                            ng-options="opt.value as opt.text for opt in ilmoittautumistilat"
                                                            ng-change="addMuokattuHakemus(tulos)"/>
                                                </div>
                                            </td>
                                            <td>
                                                <ul class="list-group">
                                                    <li class="list-group-item" ng-if="!tulos.loytyiHakemuksista">
                                                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                                                        {{ t('sijoitteluntulos.hakemustaeiloytynyt') || 'Hakemusta ei löytynyt'}}
                                                    </li>
                                                    <li class="list-group-item" ng-if="!tulos.loytyiSijoittelusta">{{ t('sijoitteluntulos.sijoittelustaeiloytynyt') || 'Sijoittelun tulosta ei löytynyt'}}</li>
                                                    <li class="list-group-item" ng-if="isVaaraVastaanottotila(tulos.valintatuloksentila)">
                                                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                                                        {{ t('sijoitteluntulos.vaaravalintatuloksentila') || 'Virheellinen vastaanottotieto'}}
                                                    </li>
                                                </ul>
                                            </td>
                                        </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td>
                                                <button ng-disabled="muokatutHakemukset.length == 0" ng-click="submitIlmanLaskentaa(valintatapajono)" class="btn btn-primary btn-sm margin-top-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</button>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                    <table ng-show="valintatapajono.kaytetaanValintalaskentaa" class="virkailija-table-1">

                                        <tbody ng-repeat="tulos in valintatapajono.hakemukset | orderBy:['jonosija', 'sukunimi']:reverse | startFrom:(valintatapajono.currentPage-1)*pageSize | limitTo:pageSize">
                                        <!-- HAKIJAN TIEDOT -->
                                        <tr class="active">
                                            <td rowspan="3">{{tulos.jonosija}}</td>
                                            <td>
                                                <show-person-information sukunimi="{{tulos.sukunimi}}"
                                                                         etunimi="{{tulos.etunimi}}"
                                                                         hakemus-oid="{{tulos.hakemusOid}}"
                                                                         haku-oid="{{hakuOid}}"
                                                                         henkilo-oid="{{tulos.hakijaOid}}"/>

                                            </td>
                                            <td>
                                                {{tulos.jarjestyskriteerit[0].arvo}}
                                            </td>
                                            <td>
                                                <div ng-if="valinnanvaihe.viimeinenVaihe">
                                                    {{ t('sijoitteluntulos.vastaanottotieto') || 'Vastaanottotieto'}}:
                                                    <div>{{ t('sijoitteluntulos.julkaistavissa') || 'Julkaistavissa' }}: <input type="checkbox" ng-change="addMuokattuHakemus(tulos)" ng-model="tulos.julkaistavissa"> <br/></div>
                                                    <div ng-show="tulos.julkaistavissa">
                                                        <span ng-bind="t('sijoitteluntulos.hakijallenaytetaan') || 'Hakijalle näytetään'"></span>:
                                                        <span ng-bind="valintatuloksenTilaKielistys(tulos.valintatuloksenTilaHakijalle)"></span>
                                                    </div>
                                                    <div ng-switch="updateOrg && tulos.julkaistavissa && tulos.valintatuloksentila !== 'OTTANUT_VASTAAN_TOISEN_PAIKAN'">
                                                        <select ng-switch-when="true"
                                                                ng-model="tulos.valintatuloksentila"
                                                                ng-options="opt.value as opt.text disable when opt.disable for opt in valintatuloksentilat"
                                                                ng-change="addMuokattuHakemus(tulos)"/>
                                                        </select>
                                                        <select disabled="disabled"
                                                                ng-switch-default
                                                                ng-model="tulos.valintatuloksentila"
                                                                ng-options="opt.value as opt.text for opt in valintatuloksentilat"
                                                                ng-change="addMuokattuHakemus(tulos)"/>
                                                        </select>
                                                    </div>
                                                </div>


                                            </td>
                                            <td>
                                                <div ng-if="valinnanvaihe.viimeinenVaihe">
                                                    {{ t('sijoitteluntulos.ilmoittautumistieto') || 'Ilmoittautumistieto'}}:
                                                    <div ng-switch="updateOrg && isVastaanottanut(tulos.valintatuloksentila) && tulos.julkaistavissa">
                                                        <select ng-switch-when="true"
                                                                ng-model="tulos.ilmoittautumistila"
                                                                ng-options="opt.value as opt.text for opt in ilmoittautumistilat"
                                                                ng-change="addMuokattuHakemus(tulos)"/>
                                                        </select>
                                                        <select disabled="disabled"
                                                                ng-switch-default
                                                                ng-model="tulos.ilmoittautumistila"
                                                                ng-options="opt.value as opt.text for opt in ilmoittautumistilat"
                                                                ng-change="addMuokattuHakemus(tulos)"/>
                                                        </select>
                                                    </div>
                                                </div>
                                            </td>
                                            <td rowspan="3" ng-class="{'bg-danger': !tulos.loytyiHakemuksista}">
                                                <ul class="list-group">
                                                    <li class="list-group-item" ng-if="!tulos.loytyiHakemuksista">
                                                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                                                        {{ t('sijoitteluntulos.hakemustaeiloytynyt') || 'Hakemusta ei löytynyt'}}
                                                    </li>
                                                    <li class="list-group-item" ng-if="!tulos.loytyiSijoittelusta">{{ t('sijoitteluntulos.sijoittelustaeiloytynyt') || 'Sijoittelun tulosta ei löytynyt'}}</li>
                                                    <li class="list-group-item" ng-if="!tulos.loytyiLaskennasta">{{ t('sijoitteluntulos.sijoittelustaeiloytynyt') || 'Laskennan tulosta ei löytynyt'}}</li>
                                                    <li class="list-group-item" ng-if="isVaaraVastaanottotila(tulos.valintatuloksentila)">
                                                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                                                        {{ t('sijoitteluntulos.vaaravalintatuloksentila') || 'Virheellinen vastaanottotieto'}}
                                                    </li>
                                                </ul>
                                            </td>
                                        </tr>

                                        <!-- LASKENNAN TULOS -->
                                        <tr>
                                            <td>{{t('erillishaku.laskennantulos') || 'Laskennan tulos'}}</td>
                                            <td>{{tulos.jarjestyskriteerit[0].tila}}</td>
                                            <td>

                                                <span ng-if="userLang=='fi' && tulos.jarjestyskriteerit[0].kuvaus.FI">{{tulos.jarjestyskriteerit[0].kuvaus.FI}}</span>
                                                <span ng-if="userLang=='sv' && tulos.jarjestyskriteerit[0].kuvaus.FI">{{tulos.jarjestyskriteerit[0].kuvaus.SV}}</span>
                                                <span ng-if="userLang=='en' && tulos.jarjestyskriteerit[0].kuvaus.FI">{{tulos.jarjestyskriteerit[0].kuvaus.EN}}</span>
                                            </td>
                                            <td>
                                                <jarjestyskriteeri-muokkaus
                                                        jonosija="tulos"
                                                        valintatapajono-oid="valintatapajono.valintatapajonooid"
                                                        hakemus-oid="tulos.hakemusOid"
                                                        enabled="jkmuokkaus"/>
                                            </td>
                                        </tr>

                                        <!-- SIJOITTELUN TULOS -->
                                        <tr ng-if="valinnanvaihe.viimeinenVaihe">
                                            <td>{{t('erillishaku.sijoitteluntulos') || 'Sijoittelun tulos'}}</td>
                                            <td>{{tulos.hakemuksentila}}</td>
                                            <td>
                                                <span ng-if="userLang=='fi' && tulos.tilanKuvaukset.FI">{{tulos.tilanKuvaukset.FI}}</span>
                                                <span ng-if="userLang=='sv' && tulos.tilanKuvaukset.SV">{{tulos.tilanKuvaukset.SV}}</span>
                                                <span ng-if="userLang=='en' && tulos.tilanKuvaukset.EN">{{tulos.tilanKuvaukset.EN}}</span>
                                            </td>
                                            <td>
                                                <sijoittelu-vastaanotto-tila hakemus="tulos"
                                                                             valintatapajono-oid="valintatapajono.oid"
                                                                             haku-oid="valinnanvaihe.hakuOid"
                                                                             hakukohde-oid="valinnanvaihe.hakukohdeOid"
                                                                             haku="hakuModel"
                                                                             enabled="jkmuokkaus"/>
                                            </td>
                                        </tr>

                                        </tbody>
                                        <tfoot>
                                        <tr>
                                            <td>
                                                <button ng-show="valintatapajono.kaytetaanValintalaskentaa" ng-disabled="muokatutHakemukset.length == 0" ng-click="submitLaskennalla(valintatapajono)" class="btn btn-primary btn-sm margin-top-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</button>
                                            </td>
                                        </tr>
                                        </tfoot>
                                    </table>

                                    <br>
                                    <pagination previous-text="{{ t('valintalaskentatulos.edellinen') || 'Edellinen' }}"
                                                next-text="{{ t('valintalaskentatulos.seuraava') || 'Seuraava' }}"
                                                total-items="valintatapajono.hakemukset.length"
                                                ng-model="valintatapajono.currentPage"
                                                ng-init="valintatapajono.currentPage=1"
                                                items-per-page="pageSize"></pagination>
                                </form>
                            </div>
                        </div>
                    </accordion-group>
                </accordion>
            </div>
        </div>
    </div>
    <div class="clear"></div>
    <div ng-show="showLoading"
         style="position: fixed; top:0; left: 0; background: gold; padding: 0.3em; font-weight: bold;">{{
        t('valintalaskentatulos.kasitellaan') || 'käsitellään' }}...
    </div>
</div>
