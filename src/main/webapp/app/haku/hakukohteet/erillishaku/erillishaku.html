<h1>{{ t('erillishaku.header') || 'Erillishaku' }}</h1>
<div ng-include="'../common/js/topnavigation/topNavigation.html'"/>

<div class="tabsheets">

<div ng-include="'haku/hakukohdelista.html'"></div>

<div class="toggle-content-container overflow-x-scroll">

<div ng-include="'../common/html/hakukohdeNimi.html'"></div>
<div ng-include="'haku/hakukohteet/hakukohdeNavigation.html'"/>
<div class="tabsheets">

<div ng-include="'../common/html/errors.html'"></div>

<input type="text" class="search margin-vertical-2"
       placeholder="{{ t('valintalaskentatulos.suodatahakijoita') || 'Suodata hakijoita' }}"
       ng-model="hakijaFilter"/>

<pagination-pagesize page-size="pageSize"></pagination-pagesize>
<div ng-if="model.ilmanlaskentaa.length > 0">
    <h2>{{ t('valintalaskentatulos.valinnanvaiheet') || 'Valinnanvaiheet, jossa ei käytetä laskentaa'
        }}</h2>
    <accordion close-others="true">
        <accordion-group 
        	ng-repeat="valinnanvaihe in model.ilmanlaskentaa | orderBy:['nimi']:false track by $index"
        	is-open="$first">

            <accordion-heading>
                <h3>{{ t('valintalaskentatulos.valinnanvaihe') || 'Valinnanvaihe' }}: <span
                        ng-bind="valinnanvaihe.nimi">-</span></h3>

            </accordion-heading>

            <div>
            	<!-- Tilanne kun sijoittelussa ei ole viela tallennettua dataa -->
                <div 	ng-if="!sijoitteluModel.sijoitteluTulokset.valintatapajonot" 
                		ng-repeat="valintatapajono in valinnanvaihe.valintatapajonot track by $index">
                    <form name="form">
                        <h3>{{ t('valintalaskentatulos.valintatapajono') || 'Valintatapajono' }}:
                            {{valintatapajono.nimi}}</h3>
                        <button ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                ng-click="erillishaunVientiXlsx(valintatapajono.oid, valintatapajono.nimi)"
                                class="btn btn-default btn-sm margin-bottom-2">{{
                            t('erillishaku.vietaulukkolaskentaan') || 'Vie taulukkolaskentaan' }}
                        </button>
	                    <span ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                       class="btn btn-primary btn-sm margin-bottom-2 btn-file">
						    {{ t('erillishaku.tuotaulukkolaskennasta') || 'Tuo taulukkolaskennasta' }} <input
                                         type="file"
                                         ng-file-select="erillishaunTuontiXlsx($files,valintatapajono.oid, valintatapajono.nimi)">
						</span>
                        <table class="virkailija-table-1">
                            <thead>
                            <tr>
                                <th>{{ t('valintalaskentatulos.hakija') || 'Hakija' }}</th>
                                <th>{{ t('sijoitteluntulos.hakemuksentila') || 'Hakemuksentila'}}</th>
                                <th>{{ t('sijoitteluntulos.vastaanottotieto') || 'Vastaanottotieto'}}</th>
                                <th>{{ t('sijoitteluntulos.ilmoittautumistieto') || 'Ilmoittautumistieto'}}</th>
                            </tr>
                            </thead>
                            <tbody >
							<tr  ng-repeat="tulos in valintatapajono.filteredResults = (valintatapajono.jonosijat | filter:hakijaFilter | orderBy:['jonosija', 'sukunimi']:reverse) | startFrom:(valintatapajono.currentPage-1)*pageSize | limitTo:pageSize">
                                <td class="leftorientedcolumn">
                                    <show-person-information sukunimi="{{tulos.sukunimi}}"
                                                             etunimi="{{tulos.etunimi}}"
                                                             hakemus-oid="{{tulos.hakemusOid}}"
                                                             haku-oid="{{hakuOid}}"
                                                             henkilo-oid="{{tulos.hakijaOid}}"/>
                                </td>
                                <td>
                                	HYLATTY
                                </td>
                                <td></td>
                                <td></td>
                            </tr>
                            </tbody>
                        </table>
                        
                    </form>
                </div>
                <div ng-repeat="valintatapajono in sijoitteluModel.sijoitteluTulokset.valintatapajonot">
                    <form name="form">
                        <h3>{{ t('valintalaskentatulos.valintatapajono') || 'Valintatapajono' }}:
                            {{valintatapajono.nimi}}</h3>
                        <button ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                ng-click="erillishaunVientiXlsx(valintatapajono.oid, valintatapajono.nimi)"
                                class="btn btn-default btn-sm margin-bottom-2">{{
                            t('erillishaku.vietaulukkolaskentaan') || 'Vie taulukkolaskentaan' }}
                        </button>
	                    <span ng-disabled="!form.$valid || form.$error.arvovalidaattori.length > 0"
                                       class="btn btn-primary btn-sm margin-bottom-2 btn-file">
						    {{ t('erillishaku.tuotaulukkolaskennasta') || 'Tuo taulukkolaskennasta' }} <input
                                         type="file"
                                         ng-file-select="erillishaunTuontiXlsx($files,valintatapajono.oid, valintatapajono.nimi)">
						</span>
                        <table class="virkailija-table-1">
                            <thead>
                            <tr>
                                <th>{{ t('valintalaskentatulos.hakija') || 'Hakija' }}</th>
                                <th>{{ t('sijoitteluntulos.hakemuksentila') || 'Hakemuksentila'}}</th>
                                <th>{{ t('sijoitteluntulos.vastaanottotieto') || 'Vastaanottotieto'}}</th>
                                <th>{{ t('sijoitteluntulos.ilmoittautumistieto') || 'Ilmoittautumistieto'}}</th>
                            </tr>
                            </thead>
                            <tbody >
	                            <tr ng-repeat="tulos in valintatapajono.hakemukset | orderBy:['jonosija', 'sukunimi']:reverse">
	                                <td class="leftorientedcolumn">
	                                    <show-person-information sukunimi="{{tulos.sukunimi}}"
	                                                             etunimi="{{tulos.etunimi}}"
	                                                             hakemus-oid="{{tulos.hakemusOid}}"
	                                                             haku-oid="{{hakuOid}}"
	                                                             henkilo-oid="{{tulos.hakijaOid}}"/>
	                                </td>
	                                <td>
	                                	{{tulos.tila}}
	                                </td>
	                                <td>
	                                	{{tulos.vastaanottoTila}}
	                                </td>
	                                <td>
	                                	{{tulos.ilmoittautumisTila}}
	                                </td>
	                            </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>
        </accordion-group>
    </accordion>
</div>

<div ng-if="model.valinnanvaiheet.length > 0">
    <h2>{{ t('valintalaskentatulos.lasketutvalinnanvaiheet') || 'Lasketut valinnanvaiheet' }}</h2>
    <accordion close-others="true">
        <accordion-group
                ng-repeat="valinnanvaihe in model.valinnanvaiheet | orderBy:['createdAt','jarjestysnumero']:true track by $index"
                is-open="$first">

            <accordion-heading>
                <h3>{{ t('valintalaskentatulos.valinnanvaihe') || 'Valinnanvaihe' }}: <span
                        ng-bind="valinnanvaihe.nimi">-</span> (<span
                        ng-bind="valinnanvaihe.createdAt | date:'dd.MM.yyyy HH:mm:ss'">-</span>)</h3>

            </accordion-heading>
            <div>
                <div ng-repeat="valintatapajono in valinnanvaihe.valintatapajonot track by $index"
                     ng-if="!valintatapajono.ilmanLaskentaa">
                    <h3>{{ t('valintalaskentatulos.valintatapajono') || 'Valintatapajono' }}:
                        {{valintatapajono.nimi}}</h3>
                    <button ng-disabled="!crudOrg"
                            ng-if="!valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                            ng-click="muutaSijoittelunStatus(valintatapajono, 'true')" class="btn btn-primary btn-sm">{{
                        t('valintalaskentatulos.hyvaksy') || 'Siirrä jono sijoitteluun' }}
                    </button>
                    <button ng-disabled="!crudOrg"
                            ng-if="valintatapajono.valmisSijoiteltavaksi && valintatapajono.siirretaanSijoitteluun"
                            ng-click="muutaSijoittelunStatus(valintatapajono, 'false')" class="btn btn-default btn-sm ">
                        {{ t('valintalaskentatulos.hylkaa') || 'Poista jono sijoittelusta' }}
                    </button>
                    <table class="table table-bordered">

                        <tbody ng-if="fetch"
                               ng-init="hakijanSijoitteluTulos = getHakijanSijoitteluTulos(valintatapajono, tulos)" ng-repeat="tulos in valintatapajono.filteredResults = (valintatapajono.jonosijat  | filter:hakijaFilter) | startFrom:(valintatapajono.currentPage-1)*pageSize | limitTo:pageSize">


                        <!-- HAKIJAN TIEDOT -->
                        <tr class="active">
                            <td>{{tulos.jonosija}}</td>
                            <td>
                                <show-person-information sukunimi="{{tulos.sukunimi}}"
                                                         etunimi="{{tulos.etunimi}}"
                                                         hakemus-oid="{{tulos.hakemusOid}}"
                                                         haku-oid="{{hakuOid}}"
                                                         henkilo-oid="{{tulos.hakijaOid}}"/>

                            </td>
                            <td>
                                {{tulos.jarjestyskriteerit[0].arvo}}
                            </td>
                            <td>
                                <div ng-if="valinnanvaihe.valinnanvaiheoid == model.lastValinnanVaihe">
                                    {{ t('sijoitteluntulos.vastaanottotieto') || 'Vastaanottotieto'}}:
                                    <div>{{ t('sijoitteluntulos.julkaistavissa') || 'Julkaistavissa' }}: <input type="checkbox" ng-model="tulos.julkaistavissa"></div>
                                    <div ng-show="tulos.julkaistavissa && (updateOrg && (hakijanSijoitteluTulos.tila == 'HYVAKSYTTY' || hakijanSijoitteluTulos.tila == 'VARASIJALTA_HYVAKSYTTY' || hakijanSijoitteluTulos.tila == 'PERUNUT' || (valintatapajono.eiVarasijatayttoa && hakijanSijoitteluTulos.tila == 'VARALLA'))) || tulos.julkaistavissa && updateOph">
                                        <span ng-show="(hakijanSijoitteluTulos.tila == 'HYVAKSYTTY' || hakijanSijoitteluTulos.tila == 'VARASIJALTA_HYVAKSYTTY' || hakijanSijoitteluTulos.tila == 'PERUNUT' || (valintatapajono.eiVarasijatayttoa && hakijanSijoitteluTulos.tila == 'VARALLA'))">
                                            <muokattu-vastaanotto-tila haku="model.haku" hakemus="tulos"/>
                                        </span>
                                    </div>
                                </div>


                            </td>
                            <td>
                                <div ng-if="valinnanvaihe.valinnanvaiheoid == model.lastValinnanVaihe">
                                    {{ t('sijoitteluntulos.ilmoittautumistieto') || 'Ilmoittautumistieto'}}:
                                        <div ng-show="tulos.muokattuVastaanottoTila == 'VASTAANOTTANUT' || tulos.muokattuVastaanottoTila == 'VASTAANOTTANUT_SITOVASTI'">
                                            <select ng-model="tulos.muokattuIlmoittautumisTila"
                                                    ng-options="tila.value as tila.text for tila in hakemuksenMuokattuIlmoittautumisTilat">
                                            </select>
                                        </div>
                                </div>
                            </td>
                        </tr>

                        <!-- LASKENNAN TULOS -->
                        <tr>
                            <td></td>
                            <td>{{t('erillishaku.laskennantulos') || 'Laskennan tulos'}}</td>
                            <td>{{tulos.tuloksenTila}}</td>
                            <td>

                                <span ng-if="userLang=='fi' && tulos.jarjestyskriteerit[0].kuvaus.FI">{{tulos.jarjestyskriteerit[0].kuvaus.FI}}</span>
                                <span ng-if="userLang=='sv' && tulos.jarjestyskriteerit[0].kuvaus.FI">{{tulos.jarjestyskriteerit[0].kuvaus.SV}}</span>
                                <span ng-if="userLang=='en' && tulos.jarjestyskriteerit[0].kuvaus.FI">{{tulos.jarjestyskriteerit[0].kuvaus.EN}}</span>
                            </td>
                            <td>
                                <jarjestyskriteeri-muokkaus
                                        jonosija="tulos"
                                        valintatapajono-oid="valintatapajono.valintatapajonooid"
                                        hakemus-oid="tulos.hakemusOid"
                                        enabled="jkmuokkaus"/>
                            </td>
                        </tr>

                        <!-- SIJOITTELUN TULOS -->
                        <tr ng-if="valinnanvaihe.valinnanvaiheoid == model.lastValinnanVaihe">
                            <td></td>
                            <td>{{t('erillishaku.sijoitteluntulos') || 'Sijoittelun tulos'}}</td>
                            <td>{{hakijanSijoitteluTulos.tila}}</td>
                            <td>
                                <span ng-if="userLang=='fi' && tulos.tilanKuvaukset.FI">{{tulos.tilanKuvaukset.FI}}</span>
                                <span ng-if="userLang=='sv' && tulos.tilanKuvaukset.SV">{{tulos.tilanKuvaukset.SV}}</span>
                                <span ng-if="userLang=='en' && tulos.tilanKuvaukset.EN">{{tulos.tilanKuvaukset.EN}}</span>
                            </td>
                            <td>
                                <sijoittelu-vastaanotto-tila hakemus="tulos"
                                                             valintatapajono-oid="valintatapajono.oid"
                                                             haku-oid="model.hakuOid"
                                                             hakukohde-oid="model.hakukohdeOid"
                                                             haku="model.haku"
                                                             enabled="jkmuokkaus"/>
                            </td>
                        </tr>
                        </tbody>


                    </table>

                    <pagination previous-text="{{ t('valintalaskentatulos.edellinen') || 'Edellinen' }}"
                                next-text="{{ t('valintalaskentatulos.seuraava') || 'Seuraava' }}"
                                total-items="valintatapajono.filteredResults.length"
                                ng-model="valintatapajono.currentPage"
                                ng-init="valintatapajono.currentPage=1"
                                items-per-page="pageSize"></pagination>
                    <br/>
                    <button ng-if="valinnanvaihe.valinnanvaiheoid == model.lastValinnanVaihe" ng-click="submit(valintatapajono)" class="btn btn-primary btn-sm margin-top-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</button>
                </div>

            </div>




        </accordion-group>
    </accordion>
</div>


</div>


</div>
<div class="clear"></div>
<div ng-show="showLoading"
     style="position: fixed; top:0; left: 0; background: gold; padding: 0.3em; font-weight: bold;">{{
    t('valintalaskentatulos.kasitellaan') || 'käsitellään' }}...
</div>
</div>
