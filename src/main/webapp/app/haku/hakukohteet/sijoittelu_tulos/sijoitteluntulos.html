<h1>{{ t('sijoitteluntulos.header') || 'Valintojen toteuttaminen' }}</h1>
<div ng-include="'haku/topNavigation.html'"></div>

<div class="tabsheets">

    <div ng-include="'haku/hakukohdelista.html'"></div>

    <div class="toggle-content-container overflow-x-scroll">

        <div ng-include="'../common/html/hakukohdeNimi.html'"></div>
        <div ng-include="'haku/hakukohteet/hakukohdeNavigation.html'"></div>

        <div class="tabsheets">

            <div ng-include="'../common/html/errors.html'"></div>

            <div ng-show="model.sijoitteluTulokset.sijoitteluajoId">
                <!--Väliaikaisesti pois suorituskyvyn parantamiseksi-->
                <!--<div class="margin-vertical-2">-->
                    <!--Viimeisimmät sijoittelun tulokset. Sijoitteluajo on alkanut <strong>{{model.latestSijoitteluajo.startMils-->
                    <!--| date:'dd.MM.yyyy HH:mm'}}</strong>-->
                    <!--ja loppunut <strong>{{model.latestSijoitteluajo.endMils | date:'dd.MM.yyyy HH:mm'}}</strong>.-->
                    <!--Sijoitteluajon tunniste on <strong>{{model.latestSijoitteluajo.sijoitteluajoId}}</strong>.-->
                    <!--Sijoittelu suoritetaan kerran vuorokaudessa.-->
                <!--</div>-->

                <br/>
                <input type="text" class="search margin-vertical-2" placeholder="{{ t('sijoitteluntulos.suodatahakijoita') || 'Suodata hakijoita' }}"
                       ng-model="hakijaFilter"/>

                <a ng-click="sijoittelunTulosXLS(); $event.stopPropagation()" class="btn btn-default btn-sm excel">{{ t('sijoitteluntulos.vietaulukkolaskentaan') || 'Vie taulukkolaskentaan' }}</a>
                <a ng-click="luoHyvaksymiskirjeetPDF(); $event.stopPropagation()" class="btn btn-default btn-sm pdf">{{ t('sijoitteluntulos.muodostahyvaksymiskirjeet') || 'Muodosta hyväksymiskirjeet' }}</a>
                <a ng-click="createHyvaksymisosoitteetPDF(); $event.stopPropagation()" class="btn btn-default btn-sm pdf">{{ t('sijoitteluntulos.muodostaosoitetarrat') || 'Muodosta hyväksytyille osoitetarrat' }}</a>

                <br/>

                <a href="/dokumenttipalvelu-service/resources/dokumentit/lataa/{{sijoitteluntuloksetUrl}}" class="btn btn-default btn-sm pdf" ng-class="{disabled: !sijoitteluntuloksetUrl}">{{ t('sijoitteluntulos.lataatulokset') || 'Lataa tulokset' }}</a>
                <a href="/dokumenttipalvelu-service/resources/dokumentit/lataa/{{hyvaksymiskirjeetUrl}}" class="btn btn-default btn-sm pdf" ng-class="{disabled: !hyvaksymiskirjeetUrl}">{{ t('sijoitteluntulos.lataahyvaksymiskirjeet') || 'Lataa hyväksymiskirjeet' }}</a>
                <a href="/dokumenttipalvelu-service/resources/dokumentit/lataa/{{osoitetarratUrl}}" class="btn btn-default btn-sm pdf" ng-class="{disabled: !osoitetarratUrl}">{{ t('sijoitteluntulos.lataaosoitetarrat') || 'Lataa osoitetarrat' }}</a>

            </div>

            <div class="margin-vertical-2 overflow-x-scroll">
                <pagination-pagesize page-size="pageSize"></pagination-pagesize>
                <div ng-repeat="jono in model.sijoitteluTulokset.valintatapajonot | orderBy:'index':true track by $index">
                    <a ng-click="submit(jono.oid)" class="btn btn-primary btn-sm margin-bottom-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</a>
                    <a ng-click="selectIlmoitettuToAll(jono.oid)" class="btn btn-default btn-sm margin-bottom-2">{{ t('sijoitteluntulos.hyvaksyvalintaesitys') || 'Hyväksy valintaesitys' }}</a>
                    <table class="virkailija-table-1">
                        <thead>
                        <tr>
                            <th colspan="10">
                                {{jono.nimi}}: {{jono.prioriteetti}} /
                                <!---Valintatapajono OID: {{jono.oid}}-->
                                {{ t('sijoitteluntulos.aloituspaikat') || 'Aloituspaikat' }}: {{jono.aloituspaikat}} /
                                {{ t('sijoitteluntulos.tasasijasaanto') || 'Tasasijasääntö' }}: {{jono.tasasijasaanto}} /
                                {{jono.eiVarasijatayttoa ? 'Ei varasijatäyttöä' : 'Varasijatäyttö'}}
                            </th>
                        </tr>
                        <tr>
                            <th>{{ t('sijoitteluntulos.jonosija') || 'Jonosija' }} ({{jono.hakemukset.length}})</th>
                            <th>{{ t('sijoitteluntulos.hakija') || 'Hakija' }}</th>
                            <th>{{ t('sijoitteluntulos.hakutoive') || 'Hakutoive' }}</th>
                            <th>{{ t('sijoitteluntulos.pisteet') || 'Pisteet' }}</th>
                            <th>{{ t('sijoitteluntulos.sijoitteluntila') || 'Sijoittelun tila' }}</th>
                            <th>{{ t('sijoitteluntulos.vastaanottotieto') || 'Vastaanottotieto' }}</th>
                            <th>{{ t('sijoitteluntulos.ilmoittautumistieto') || 'Ilmoittautumistieto' }}</th>
                            <th>{{ t('sijoitteluntulos.muokattu') || 'Muokattu' }}</th>
                            <th>{{ t('sijoitteluntulos.muokkaa') || 'Muokkaa' }}</th>
                            <th>{{ t('sijoitteluntulos.toiminto') || 'Toiminto' }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="hakemus in filteredResults[$index] = (jono.hakemukset | orderBy:['sija'] | filter:hakijaFilter) | startFrom:(currentPage[$index]-1)*pageSize | limitTo:pageSize">
                            <td><span ng-if="hakemus.sija > 0">{{hakemus.sija}}</span></td>
                            <td class="leftorientedcolumn">
                                <show-person-information sukunimi="{{hakemus.sukunimi}}"
                                                         etunimi="{{hakemus.etunimi}}"
                                                         hakemus-oid="{{hakemus.hakemusOid}}"
                                                         haku-oid="{{hakuOid}}"
                                                         henkilo-oid="{{hakemus.hakijaOid}}"/>
                            </td>
                            <td>{{hakemus.prioriteetti}}</td>
                            <td><span ng-if="hakemus.pisteet >= 0">{{hakemus.pisteet}}</span></td>
                            <td>
                                <span>{{hakemus.tila}}</span>
                                <span ng-if="hakemus.tila == 'HYVAKSYTTY' && hakemus.hyvaksyttyHarkinnanvaraisesti == true">({{ t('sijoitteluntulos.harkinnanvaraisesti') || 'Harkinnanvaraisesti' }})</span>
                                <span ng-if="hakemus.varasijanNumero != undefined">({{hakemus.varasijanNumero}})</span>
                                <modal modal-template="sijoitteluTilaHistoriModal.html">
                                    <modal-open>
                                        {{(hakemus.tilaHistoria
                                        | orderBy:'luotu':true | limitTo:1)[0].luotu | date:'dd.MM.yyyy HH:mm'}}
                                    </modal-open>
                                </modal>
                            </td>

                            <td>
                                <div ng-show="(updateOrg && (hakemus.tila == 'HYVAKSYTTY' || (jono.eiVarasijatayttoa && hakemus.tila == 'VARALLA'))) || updateOph">
                                    <span ng-show="(hakemus.tila == 'HYVAKSYTTY' || (jono.eiVarasijatayttoa && hakemus.tila == 'VARALLA'))">
                                        <select ng-change="resetIlmoittautumisTila(hakemus)" ng-model="hakemus.muokattuVastaanottoTila" ng-options="tila.value as (tila.value | translate) for tila in hakemuksenMuokattuVastaanottoTilat">
                                            <option value="">{{ t('sijoitteluntulos.kesken') || 'Kesken' }}</option>
                                        </select>
                                    </span>
                                </div>
                                <div ng-if="(!jono.eiVarasijatayttoa && hakemus.tila == 'VARALLA')">
                                    {{ hakemus.vastaanottoTila | translate }}
                                </div>
                            </td>

                            <td>
                                <div ng-show="hakemus.muokattuVastaanottoTila == 'VASTAANOTTANUT' || hakemus.muokattuVastaanottoTila == 'EHDOLLISESTI_VASTAANOTTANUT'">
                                      <select ng-disabled="!(updateOrg || updateOph)"
                                              ng-model="hakemus.muokattuIlmoittautumisTila"
                                              ng-options="tila.value as tila.text | translate for tila in hakemuksenMuokattuIlmoittautumisTilat">
                                      </select>
                                 </div>
                            </td>

                            <td>
                                <modal modal-template="sijoitteluLogModal.html">
                                    <modal-open>
                                        {{hakemus.logEntries[hakemus.logEntries.length-1].luotu
                                        | date:'dd.MM.yyyy HH:mm'}}
                                    </modal-open>

                                </modal>
                            </td>
                            <td>
                                <sijoittelu-vastaanotto-tila hakemus="hakemus"
                                                             valintatapajono-oid="jono.oid"
                                                             haku-oid="model.hakuOid"
                                                             hakukohde-oid="model.hakukohdeOid"
                                                             haku="model.haku"
                                                             enabled="updateOph"/>
                            </td>
                            <td>
								<a ng-if="hakemus.tila == 'HYVAKSYTTY'" ng-click="createHyvaksymiskirjeetPDF([hakemus.hakemusOid]); $event.stopPropagation()" class="btn btn-default btn-sm pdf">{{ t('sijoitteluntulos.hyvaksymiskirje') || 'Hyväksymiskirje' }}</a>
							</td>
                        </tr>
                        </tbody>
                    </table>
                    <pagination previous-text="{{ t('sijoitteluntulos.edellinen') || 'Edellinen' }}" next-text="{{ t('sijoitteluntulos.seuraava') || 'Seuraava' }}" total-items="filteredResults[$index].length" ng-model="currentPage[$index]" items-per-page="pageSize"></pagination>
                    <br/>
                    <a ng-click="submit(jono.oid)" class="btn btn-primary btn-sm margin-top-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</a>
                </div>
            </div>
        </div>
    </div>
    <div class="clear"></div>
    <div ng-show="showLoading"
         style="position: fixed; top:0; left: 0; background: gold; padding: 0.3em; font-weight: bold;">{{ t('sijoitteluntulos.kasitellaan') || 'käsitellään' }}...
    </div>
</div>


<script type="text/ng-template" id="sijoitteluLogModal.html">
    <div class="modal-header">
        {{ t('sijoitteluntulos.muutokset') || 'Muutokset' }}
    </div>

    <div class="modal-body">
        <table class="table table-condensed table-hover table-striped">
            <thead>
            <tr>
                <th>{{ t('sijoitteluntulos.luotu') || 'Luotu' }}</th>
                <th>{{ t('sijoitteluntulos.muokkaaja') || 'Muokkaaja' }}</th>
                <th>{{ t('sijoitteluntulos.muutos') || 'Muutos' }}</th>
                <th>{{ t('sijoitteluntulos.selite') || 'Selite' }}</th>
            </tr>
            </thead>
            <tr ng-repeat="entry in hakemus.logEntries | orderBy:'luotu':true">
                <td fast-bind-once="entry.luotu | date:'dd.MM.yyyy HH:mm'"></td>
                <td fast-bind-once="entry.muokkaaja"></td>
                <td>
                    <span ng-if="entry.muutos == ''">{{ t('sijoitteluntulos.kesken') || 'Kesken' }}</span>
                    <span ng-if="entry.muutos == 'ILMOITETTU'">{{ t('sijoitteluntulos.hakijalleilmoitettu') || 'Hakijalle ilmoitettu' }}</span>
                    <span ng-if="entry.muutos == 'VASTAANOTTANUT_LASNA'">{{ t('sijoitteluntulos.vastaanottanutlasnaolevana') || 'Vastaanottanut läsnäolevana' }}</span>
                    <span ng-if="entry.muutos == 'VASTAANOTTANUT_POISSAOLEVA'">{{ t('sijoitteluntulos.vastaanottanutpoissaolevana') || 'Vastaanottanut poissaolevana' }}</span>
                    <span ng-if="entry.muutos == 'EI_VASTAANOTETTU_MAARA_AIKANA'">{{ t('sijoitteluntulos.eivastaanotettu') || 'Ei vastaanotettu määräaikana' }}</span>
                    <span ng-if="entry.muutos == 'PERUNUT'">{{ t('sijoitteluntulos.perunut') || 'Perunut' }}</span>
                    <span ng-if="entry.muutos == 'PERUUTETTU'">{{ t('sijoitteluntulos.peruutettu') || 'Peruutettu' }}</span>
                    <span ng-if="entry.muutos == 'EHDOLLISESTI_VASTAANOTTANUT'">{{ t('sijoitteluntulos.ehdollisestivastaanottanut') || 'Ehdollisesti vastaanottanut' }}</span>
                </td>
                <td fast-bind-once="entry.selite"></td>
            </tr>
        </table>
    </div>

    <div class="modal-footer">
        <div class="row">
            <a class="btn btn-default btn-sm" ng-click="sulje();"
               role="button">{{ t('sijoitteluntulos.sulje') || 'Sulje' }}</a>
        </div>
    </div>

</script>

<script type="text/ng-template" id="sijoitteluTilaHistoriModal.html">
    <div class="modal-header">
        {{ t('sijoitteluntulos.muutokset') || 'Muutokset' }}
    </div>

    <div class="modal-body">
        <table class="table table-condensed table-hover table-striped">
            <thead>
            <tr>
                <th>{{ t('sijoitteluntulos.luotu') || 'Luotu' }}</th>
                <th>{{ t('sijoitteluntulos.tila') || 'Tila' }}</th>
            </tr>
            </thead>
            <tr ng-repeat="entry in hakemus.tilaHistoria | orderBy:'luotu':true">
                <td fast-bind-once="entry.luotu | date:'dd.MM.yyyy HH:mm'"></td>
                <td fast-bind-once="henkiloOid">{{entry.tila}}</td>
            </tr>
        </table>
    </div>

    <div class="modal-footer">
        <div class="row">
            <a class="btn btn-default btn-sm" ng-click="sulje();"
               role="button">{{ t('sijoitteluntulos.sulje') || 'Sulje' }}</a>
        </div>
    </div>

</script>