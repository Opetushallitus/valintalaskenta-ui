<h1>{{ t('sijoitteluntulos.header') || 'Valintojen toteuttaminen' }}</h1>
<div ng-include="'../common/js/topnavigation/topNavigation.html'"></div>

<div class="tabsheets">

    <div ng-include="'haku/hakukohdelista.html'"></div>

    <div class="toggle-content-container overflow-x-scroll">

        <div ng-include="'../common/html/hakukohdeNimi.html'"></div>
        <div ng-include="'haku/hakukohteet/hakukohdeNavigation.html'"></div>

        <div class="tabsheets">

            <div ng-include="'../common/html/errors.html'"></div>

            <div ng-show="model.sijoitteluTulokset.sijoitteluajoId">
                <!--Väliaikaisesti pois suorituskyvyn parantamiseksi-->
                <!--<div class="margin-vertical-2">-->
                    <!--Viimeisimmät sijoittelun tulokset. Sijoitteluajo on alkanut <strong>{{model.latestSijoitteluajo.startMils-->
                    <!--| date:'dd.MM.yyyy HH:mm'}}</strong>-->
                    <!--ja loppunut <strong>{{model.latestSijoitteluajo.endMils | date:'dd.MM.yyyy HH:mm'}}</strong>.-->
                    <!--Sijoitteluajon tunniste on <strong>{{model.latestSijoitteluajo.sijoitteluajoId}}</strong>.-->
                    <!--Sijoittelu suoritetaan kerran vuorokaudessa.-->
                <!--</div>-->
                <span>{{ t('valintakoetulos.nayta') || 'Näytä' }}</span>
                <select ng-model="nakymanTila" ng-change="updateNakymanTila()">
                    <option value="Jonottain" selected="selected">{{ t('sijoitteluntulos.jonottain') || 'Jonottain' }}</option>
                    <option value="Hakijoittain">{{ t('sijoitteluntulos.hakijoittain') || 'Hakijoittain' }}</option>
                </select>
                <br/>
                <tila-filter tila-filter-value="tilaFilterValue" filter-values="tilaFilterValues"></tila-filter>

                <a ng-click="sijoittelunTulosXLS(); $event.stopPropagation()" class="btn btn-default btn-sm excel">{{ t('sijoitteluntulos.vietaulukkolaskentaan') || 'Vie taulukkolaskentaan' }}</a>
                <a ng-class="{disabled: !enableTulostus()}" ng-click="luoHyvaksymiskirjeetPDF(); $event.stopPropagation()" class="btn btn-default btn-sm pdf testLuoHyvaksymiskirjeet">{{ t('sijoitteluntulos.muodostahyvaksymiskirjeet') || 'Muodosta hyväksymiskirjeet' }}</a>
                <a ng-show="showJalkiohjaus()" ng-class="{disabled: !enableTulostus()}"  ng-click="luoJalkiohjauskirjeetPDF(); $event.stopPropagation()" class="btn btn-default btn-sm pdf testJalkiohjaus">
                    <span ng-if="korkeakouluService.isKorkeakoulu(hakuModel.hakuOid.kohdejoukkoUri)">{{ t('sijoitteluntulos.muodostaeihyvaksyttyjenkirjeet') || 'Muodosta kirjeet ei-hyväksytyille'}}</span>
                    <span ng-if="!korkeakouluService.isKorkeakoulu(hakuModel.hakuOid.kohdejoukkoUri)">{{ t('sijoitteluntulos.muodostajalkiohjauskirjeet') || 'Muodosta jälkiohjauskirjeet hakukohteessa hylätyille' }}</span>
                </a>
                <a ng-class="{disabled: !enableTulostus()}"  ng-click="createHyvaksymisosoitteetPDF(); $event.stopPropagation()" class="btn btn-default btn-sm pdf testCreateHyvaksymisosoitteet">{{ t('sijoitteluntulos.muodostaosoitetarrat') || 'Muodosta hyväksytyille osoitetarrat' }}</a>
                <br/>

                <a href="/dokumenttipalvelu-service/resources/dokumentit/lataa/{{sijoitteluntuloksetUrl}}" class="btn btn-default btn-sm pdf" ng-class="{disabled: !sijoitteluntuloksetUrl}">{{ t('sijoitteluntulos.lataatulokset') || 'Lataa tulokset' }}</a>
                <a href="/dokumenttipalvelu-service/resources/dokumentit/lataa/{{hyvaksymiskirjeetUrl}}" class="btn btn-default btn-sm pdf" ng-class="{disabled: !hyvaksymiskirjeetUrl || !enableTulostus()}">{{ t('sijoitteluntulos.lataahyvaksymiskirjeet') || 'Lataa hyväksymiskirjeet' }}</a>
                <a href="/dokumenttipalvelu-service/resources/dokumentit/lataa/{{osoitetarratUrl}}" class="btn btn-default btn-sm pdf" ng-class="{disabled: !osoitetarratUrl || !enableTulostus()}">{{ t('sijoitteluntulos.lataaosoitetarrat') || 'Lataa osoitetarrat' }}</a>

            </div>

            <div ng-if="nakymanTila == 'Hakijoittain'">
                <h2>{{ t('valintakoetulos.hakijoittain') || 'Hakijoittain' }}</h2>
                <a ng-click="submit(jono.oid)" class="btn btn-primary btn-sm margin-bottom-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</a>
                <div>{{ t('sijoitteluntulos.muuttuneettiedot') || 'Näytä vain muuttuneet tiedot' }}: <input type="checkbox" ng-model="model.naytaVainMuuttuneet" ng-change="filterChangedValues(model.naytaVainMuuttuneet,model.sijoitteluntulosHakijoittainTableParams)"> <br/></div>

                <table ng-table="model.sijoitteluntulosHakijoittainTableParams" show-filter="true" class="virkailija-table-1">
                    <tbody ng-repeat="hakija in $data">
                        <tr class="ng-table-group">
                            <td colspan="2">
                                <a href="" ng-click="hakija.$hideRows = !hakija.$hideRows">
                                    <span class="glyphicon" ng-class="{ 'glyphicon-chevron-right': hakija.$hideRows, 'glyphicon-chevron-down': !hakija.$hideRows }"></span>
                                    <strong>
                                        <show-person-info-with-vts-data sukunimi="{{hakija.sukunimi}}"
                                                                   etunimi="{{hakija.etunimi}}"
                                                                   hakemus-oid="{{hakija.hakemusOid}}"
                                                                   haku-oid="{{hakuOid}}"
                                                                   henkilo-oid="{{hakija.hakijaOid}}"/>
                                    </strong>
                                </a>
                            </td>
                            <td>
                                {{ t('sijoitteluntulos.vastaanottotila') || 'Vastaanottotila' }}:&nbsp;{{hakija.muokattuVastaanottoTila || hakija.vastaanottoTila}}
                            </td>
                            <td>
                                {{ t('sijoitteluntulos.ilmoittautumistila') || 'Ilmoittautumistila' }}:&nbsp;{{hakija.ilmoittautumisTila}}
                            </td>
                        </tr>
                        <tr ng-hide="hakija.$hideRows" ng-repeat="jono in hakija.jonot | tilaFilter: tilaFilterValue">
                            <td data-title="(t('sijoitteluntulos.jonosija') || 'Jonosija')" sortable="'sija'">
                                {{jono.sija > 0?jono.sija:""}}
                            </td>
                            <td data-title="(t('sijoitteluntulos.jononnimi') || 'Jonon nimi')" sortable="'nimi'">
                                {{jono.nimi}}
                            </td>
                            <td data-title="(t('sijoitteluntulos.yhteispisteet') || 'Pisteet')" sortable="'pisteet'">
                                {{jono.pisteet >= 0?jono.pisteet:""}}
                            </td>
                            <td data-title="(t('sijoitteluntulos.sijoitteluntila') || 'Sijoittelun tila')" sortable="'tila'">
                                <show-sijoittelun-tila hakemus="jono" user-lang="userLang" on-edit="addMuokattuHakemus(hakemus)"></show-sijoittelun-tila>
                                <modal modal-template="sijoitteluTilaHistoriaModal.html" hakemus="{{hakija}}">
                                    <modal-open>
                                        {{(jono.tilaHistoria
                                        | orderBy:'luotu':true | limitTo:1)[0].luotu | date:'dd.MM.yyyy HH:mm'}}
                                    </modal-open>
                                </modal>
                            </td>
                        </tr>
                    </tbody>
                </table>

                 <br/>
                <a ng-click="submit(jono.oid)" class="btn btn-primary btn-sm margin-top-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</a>
            </div>

            <div class="margin-vertical-2 overflow-x-scroll" ng-if="nakymanTila == 'Jonottain'">
                <div ng-repeat="jono in model.sijoitteluTulokset.valintatapajonot | orderBy:'prioriteetti' track by $index" class="virkailija-jono-container">
                    <a ng-click="selectIlmoitettuToAll(jono.oid)"
                       class="btn btn-default btn-sm margin-bottom-2"
                       ng-class='(updateOph || valintaesitysJulkaistavissa) ? "" : "disabled"'>
                        {{ t('sijoitteluntulos.hyvaksyvalintaesitys') || 'Hyväksy ja tallenna valintaesitys' }}
                    </a>
                    <a ng-click="selectEiVastanotettuMaaraaikanaToAll(jono.oid)"
                       class="btn btn-default btn-sm margin-bottom-2"
                       ng-class='(model.myohastymistietoLadattu && (updateOph || valintaesitysJulkaistavissa)) ? "" : "disabled"'>
                        {{ t('sijoitteluntulos.merkitsemyohastyneeksi') || 'Merkitse myöhästyneeksi' }}
                    </a>
                    <br/>
                    <a ng-click="submit(jono.oid)" class="btn btn-primary btn-sm margin-bottom-2">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</a>
                    <div>{{ t('sijoitteluntulos.muuttuneettiedot') || 'Näytä vain muuttuneet tiedot' }}: <input type="checkbox" ng-model="jono.naytaVainMuuttuneet" ng-change="filterChangedValues(jono.naytaVainMuuttuneet,jono.tableParams)"> <br/></div>

                    <table ng-table="jono.tableParams" show-filter="true" class="virkailija-table-1">
                        <tbody>
                            <tr class="ng-table-group">
                                <th colspan="11">
                                    {{jono.nimi}}: {{jono.prioriteetti}} /
                                    <!---Valintatapajono OID: {{jono.oid}}-->
                                    <span ng-if="korkeakouluService.isKorkeakoulu(hakuModel.hakuOid.kohdejoukkoUri)">{{ t('sijoitteluntulos.aloituspaikat') || 'Valintaperusteissa määritetyt aloituspaikat' }}: {{jono.alkuperaisetAloituspaikat}} /</span>
                                    {{ t('sijoitteluntulos.sijoittelunAloituspaikat') || 'Sijoittelun käyttämät aloituspaikat' }}: {{jono.aloituspaikat}} /
                                    {{ t('sijoitteluntulos.tasasijasaanto') || 'Tasasijasääntö' }}: {{jono.tasasijasaanto}} /
                                    {{jono.eiVarasijatayttoa ? 'Ei varasijatäyttöä' : 'Varasijatäyttö'}} /
                                    {{ t('sijoitteluntulos.jononprioriteetti') || 'Prioriteetti' }}: {{jono.prioriteetti}}
                                </th>
                            </tr>
                            <tr ng-repeat="hakemus in ($data | tilaFilter: tilaFilterValue)">
                                <td data-title="jonoLength(jono.hakemukset.length)" sortable="'sija'">
                                    {{hakemus.sija > 0?hakemus.sija:""}}
                                </td>
                                <td class="leftorientedcolumn" data-title="(t('sijoitteluntulos.hakija') || 'Hakija')"
                                    sortable="'sukunimi'" filter="{ 'sukunimi' : 'text' }">
                                    <show-person-info-with-vts-data sukunimi="{{hakemus.sukunimi}}"
                                                             etunimi="{{hakemus.etunimi}}"
                                                             hakemus-oid="{{hakemus.hakemusOid}}"
                                                             haku-oid="{{hakuOid}}"
                                                             henkilo-oid="{{hakemus.hakijaOid}}"/>
                                </td>
                                <td data-title="(t('sijoitteluntulos.hakutoive') || 'Hakutoive')" sortable="'prioriteetti'">
                                    {{hakemus.prioriteetti}}
                                </td>
                                <td data-title="(t('sijoitteluntulos.pisteet') || 'Pisteet')" sortable="'pisteet'">
                                    <span ng-if="hakemus.pisteet >= 0">{{hakemus.pisteet}}</span>
                                </td>
                                <td data-title="(t('sijoitteluntulos.sijoitteluntila') || 'Sijoittelun tila')" sortable="'tilaPrioriteetti'">
                                    <show-sijoittelun-tila hakemus="hakemus" user-lang="userLang" on-edit="addMuokattuHakemus(hakemus)"></show-sijoittelun-tila>
                                    <siirtynyt-toisesta-valintatapajonosta-indicator hakemus="hakemus"></siirtynyt-toisesta-valintatapajonosta-indicator>
                                    <modal modal-template="sijoitteluTilaHistoriaModal.html">
                                        <modal-open>
                                            {{(hakemus.tilaHistoria
                                            | orderBy:'luotu':true | limitTo:1)[0].luotu | date:'dd.MM.yyyy HH:mm'}}
                                        </modal-open>
                                    </modal>
                                    <div ng-show="showEhdollinenHyvaksynta()" class="white-space-nowrap testEhdollinenValinta">
                                        <span>{{ t('sijoitteluntulos.ehdollisestihyvaksyttavissa') || 'Ehdollinen valinta' }}:</span>
                                        <input ng-disabled="!(updateOrg)" type="checkbox" ng-model="hakemus.ehdollisestiHyvaksyttavissa" ng-change="addMuokattuHakemus(hakemus)"/>
                                    </div>
                                </td>
                                <td data-title="(t('sijoitteluntulos.varasijatoiminto') || 'Varasijalta hyväksyminen')" sortable="'tila'">
                                    <div ng-show="hakemus.tila == 'VARALLA' && (updateOph || updateVarasijaltaHyvaksytty)">{{ t('sijoitteluntulos.varasijahyvaksy') || 'Hyväksytään varasijalta' }}: <input type="checkbox" ng-change="addMuokattuHakemus(hakemus)" ng-model="hakemus.hyvaksyttyVarasijalta"></div>
                                </td>
                                <td data-title="(t('sijoitteluntulos.vastaanottotieto') || 'Vastaanottotieto')" sortable="'vastaanottoTila'">
                                    <div class="white-space-nowrap">
                                        <span>{{ t('sijoitteluntulos.julkaistavissa') || 'Julkaistavissa' }}:</span>
                                        <input ng-disabled="(hakemus.muokattuVastaanottoTila === 'VASTAANOTTANUT_SITOVASTI' || hakemus.muokattuVastaanottoTila === 'EHDOLLISESTI_VASTAANOTTANUT' || hakemus.muokattuVastaanottoTila === 'VASTAANOTTANUT' || hakemus.muokattuVastaanottoTila === 'PERUUTETTU' || hakemus.muokattuVastaanottoTila === 'PERUNUT') || !(updateOph || valintaesitysJulkaistavissa)" type="checkbox" ng-change="addMuokattuHakemus(hakemus)" ng-model="hakemus.julkaistavissa"/>
                                    </div>
                                    <div ng-if="hakemus.naytetaanVastaanottotieto">
                                        <div ng-show="hakemus.julkaistavissa && (updateOrg && (hakemus.tila == 'HYVAKSYTTY' || hakemus.tila == 'VARASIJALTA_HYVAKSYTTY' || hakemus.tila == 'PERUNUT' || (jono.eiVarasijatayttoa && hakemus.tila == 'VARALLA'))) || hakemus.julkaistavissa && updateOph">
                                            <div>
                                                <span ng-bind="t('sijoitteluntulos.hakijallenaytetaan') || 'Hakijalle näytetään'"></span>
                                                <span>: </span>
                                                <span ng-bind="t('sijoitteluntulos.' + ( hakemus.tilaHakijalle.toLowerCase() | removeUnderscores) ) || hakemus.tilaHakijalle.toLowerCase() | removeUnderscores"></span>
                                                <div ng-if="hakemus.vastaanottoAikaraja">
                                                    <span ng-bind="t('sijoitteluntulos.vastaanottoaikaraja') || 'Aikaraja'"></span>:
                                                    <span>{{hakemus.vastaanottoAikaraja | date:'dd.MM.yyyy HH:mm'}}</span>
                                                </div>
                                                <span ng-show="(hakemus.tila == 'HYVAKSYTTY' || hakemus.tila == 'VARASIJALTA_HYVAKSYTTY' || hakemus.tila == 'PERUNUT' || (jono.eiVarasijatayttoa && hakemus.tila == 'VARALLA'))">
                                                    <muokattu-vastaanotto-tila haku="model.haku" hakemus="hakemus"/>
                                                </span>
                                        </div>
                                    </div>
                                  </div>
                                </td>
                                <td data-title="(t('sijoitteluntulos.ilmoittautumistieto') || 'Ilmoittautumistieto')" sortable="'muokattuIlmoittautumisTila'">
                                    <div ng-show="hakemus.naytetaanVastaanottotieto && (hakemus.muokattuVastaanottoTila == 'VASTAANOTTANUT' || hakemus.muokattuVastaanottoTila == 'VASTAANOTTANUT_SITOVASTI')">
                                        <select ng-model="hakemus.muokattuIlmoittautumisTila" ng-change="addMuokattuHakemus(hakemus)"
                                                ng-options="tila.value as tila.text for tila in hakemuksenMuokattuIlmoittautumisTilat">
                                        </select>
                                    </div>
                                </td>
                                <td data-title="(t('sijoitteluntulos.muokattu') || 'Muokattu')" sortable="'muokattuVastaanottoTila'">
                                    <span ng-if="hakemus.naytetaanVastaanottotieto && hakemus.logEntries[hakemus.logEntries.length-1].luotu">{{hakemus.muokattuVastaanottoTila}}</span>
                                    <modal ng-if="hakemus.naytetaanVastaanottotieto" modal-template="sijoitteluLogModal.html">
                                        <modal-open>
                                            {{hakemus.logEntries[hakemus.logEntries.length-1].luotu
                                            | date:'dd.MM.yyyy HH:mm'}}
                                        </modal-open>

                                    </modal>
                                </td>
                                <td data-title="(t('sijoitteluntulos.muokkaa') || 'Muokkaa')" sortable="'muokattuIlmoittautumisTila'">
                                    <sijoittelu-vastaanotto-tila hakemus="hakemus"
                                                                 hakukohde="hakukohdeModel"
                                                                 valintatapajono-oid="jono.oid"
                                                                 haku-oid="model.hakuOid"
                                                                 hakukohde-oid="model.hakukohdeOid"
                                                                 haku="model.haku"
                                                                 enabled="updateOph"/>
                                </td>
                                <td data-title="(t('sijoitteluntulos.toiminto') || 'Toiminto')">
                                    <a ng-if="hakemus.tila == 'HYVAKSYTTY' || hakemus.tila == 'VARASIJALTA_HYVAKSYTTY'" ng-click="createHyvaksymiskirjeetPDF([hakemus.hakemusOid]); $event.stopPropagation()" class="btn btn-default btn-sm pdf">{{ t('sijoitteluntulos.hyvaksymiskirje') || 'Hyväksymiskirje' }}</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <br/>
                    <a ng-click="submit(jono.oid)" class="btn btn-primary btn-sm margin-top-0">{{ t('sijoitteluntulos.tallenna') || 'Tallenna' }}</a>
                </div>
            </div>
        </div>
    </div>
    <div class="clear"></div>
    <div ng-show="showLoading"
         style="position: fixed; top:0; left: 0; background: gold; padding: 0.3em; font-weight: bold;">{{ t('sijoitteluntulos.kasitellaan') || 'käsitellään' }}...
    </div>
</div>


<script type="text/ng-template" id="sijoitteluLogModal.html">
    <div class="modal-header">
        {{ t('sijoitteluntulos.muutokset') || 'Muutokset' }}
    </div>

    <div class="modal-body">
        <show-vastaanottanut-tila log-entries="hakemus.logEntries"></show-vastaanottanut-tila>
    </div>

    <div class="modal-footer">
        <div class="row">
            <a class="btn btn-default btn-sm" ng-click="sulje();"
               role="button">{{ t('sijoitteluntulos.sulje') || 'Sulje' }}</a>
        </div>
    </div>

</script>

<script type="text/ng-template" id="sijoitteluTilaHistoriaModal.html">
    <div class="modal-header">
        {{ t('sijoitteluntulos.muutokset') || 'Muutokset' }}
    </div>

    <div class="modal-body">
        <table class="table table-condensed table-hover table-striped">
            <thead>
            <tr>
                <th>{{ t('sijoitteluntulos.luotu') || 'Luotu' }}</th>
                <th>{{ t('sijoitteluntulos.tila') || 'Tila' }}</th>
            </tr>
            </thead>
            <tr ng-repeat="entry in (hakemus.tilaHistoria.length>0?hakemus.tilaHistoria:hakija.tilaHistoria) | orderBy:'luotu':true">
                <td fast-bind-once="entry.luotu | date:'dd.MM.yyyy HH:mm'"></td>
                <td fast-bind-once="henkiloOid">{{entry.tila}}</td>
            </tr>
        </table>
    </div>

    <div class="modal-footer">
        <div class="row">
            <a class="btn btn-default btn-sm" ng-click="sulje();"
               role="button">{{ t('sijoitteluntulos.sulje') || 'Sulje' }}</a>
        </div>
    </div>

</script>
